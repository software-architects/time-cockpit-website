---
layout: blog
title: ALM Days, Unit Testing with Stubs, Shims, and MS Fakes
author: Rainer Stropek
bannerimage: 
permalink: /2014/02/25/ALM-Days-Unit-Testing-with-Stubs-Shims-and-MS-Fakes
---

<p xmlns="http://www.w3.org/1999/xhtml">At <a href="http://alm-days.de/" target="_blank">ALM Days</a> my second talk is about unit testing with <a href="http://msdn.microsoft.com/en-us/library/hh549175.aspx" target="_blank">Microsoft Fakes</a>, Stubs, and Shims. Here is the sample that I am going to use.</p><p class="showcase" xmlns="http://www.w3.org/1999/xhtml">A reference implementation of the sample can be found on <a href="https://github.com/rstropek/Samples/tree/master/SudokuBoard" target="_blank">GitHub</a>. During the session coding will be live. Therefore it is likely that the sample shown in the session is not 100% identical with the reference implementation on GitHub.</p><h2 xmlns="http://www.w3.org/1999/xhtml">Sample 1: Integration Tests</h2><p xmlns="http://www.w3.org/1999/xhtml">My sample contains a class <a href="https://github.com/rstropek/Samples/blob/master/SudokuBoard/Samples.Sudoku/BoardStreamRepository.cs"><em>BoardStreamRepository</em></a>. It can handle any kind of stream and uses the interface <a href="https://github.com/rstropek/Samples/blob/master/SudokuBoard/Samples.Sudoku/IStreamManager.cs"><em>IStreamManager</em></a> to get it. The sample project contains two implementations of this interface: One for local files (<a href="https://github.com/rstropek/Samples/blob/master/SudokuBoard/Samples.Sudoku/FileStreamManager.cs"><em>FileStreamManager</em></a>) and one for Windows Azure Blob Storage (<a href="https://github.com/rstropek/Samples/blob/master/SudokuBoard/Samples.Sudoku/CloudBlobStreamManager.cs"><em>CloudBlobStreamManager</em></a>). You could write integration tests for both classes:</p><f:function name="Composite.Web.Html.SyntaxHighlighter" xmlns:f="http://www.composite.net/ns/function/1.0">
  <f:param name="SourceCode" value="namespace Samples.Sudoku.Test&#xA;{&#xA;&#x9;using Microsoft.VisualStudio.TestTools.UnitTesting;&#xA;&#x9;using System.IO;&#xA;&#x9;using System.Linq;&#xA;&#x9;using System.Reflection;&#xA;&#x9;using System.Threading.Tasks;&#xA;&#xA;&#x9;/// &lt;summary&gt;&#xA;&#x9;/// Integration tests for reading/writing board data.&#xA;&#x9;/// &lt;/summary&gt;&#xA;&#x9;[TestClass]&#xA;&#x9;public class BoardReaderWriterIntegrationTests&#xA;&#x9;{&#xA;&#x9;&#x9;public TestContext TestContext { get; set; }&#xA;&#xA;&#x9;&#x9;[TestMethod]&#xA;&#x9;&#x9;[TestCategory(&quot;Integration&quot;)]&#xA;&#x9;&#x9;public async Task TestLoadBoardFromFile()&#xA;&#x9;&#x9;{&#xA;&#x9;&#x9;&#x9;const string sampleBoardName = &quot;SampleBoard&quot;;&#xA;&#xA;&#x9;&#x9;&#x9;var directory = Path.Combine(this.TestContext.TestDir, &quot;Boards&quot;);&#xA;&#x9;&#x9;&#x9;await Task.Run(() =&gt; Directory.CreateDirectory(directory));&#xA;&#x9;&#x9;&#x9;using (var stream = new FileStream(Path.Combine(directory, sampleBoardName), FileMode.CreateNew))&#xA;&#x9;&#x9;&#x9;{&#xA;&#x9;&#x9;&#x9;&#x9;await stream.WriteAsync(BoardSampleData.sampleBoard, 0, BoardSampleData.sampleBoard.Length);&#xA;&#x9;&#x9;&#x9;}&#xA;&#xA;&#x9;&#x9;&#x9;var board = await BoardReader.LoadFromFileAsync(sampleBoardName, directory);&#xA;&#x9;&#x9;&#x9;Assert.IsTrue(((byte[])board).SequenceEqual(BoardSampleData.sampleBoard));&#xA;&#x9;&#x9;}&#xA;&#x9;}&#xA;}" xmlns:f="http://www.composite.net/ns/function/1.0" />
  <f:param name="CodeType" value="c#" xmlns:f="http://www.composite.net/ns/function/1.0" />
</f:function><f:function name="Composite.Web.Html.SyntaxHighlighter" xmlns:f="http://www.composite.net/ns/function/1.0">
  <f:param name="SourceCode" value="namespace Samples.Sudoku.Test&#xA;{&#xA;&#x9;using Microsoft.QualityTools.Testing.Fakes;&#xA;&#x9;using Microsoft.VisualStudio.TestTools.UnitTesting;&#xA;&#x9;using Microsoft.WindowsAzure.Storage;&#xA;&#x9;using Microsoft.WindowsAzure.Storage.Auth;&#xA;&#x9;using Microsoft.WindowsAzure.Storage.Blob;&#xA;&#x9;using Microsoft.WindowsAzure.Storage.Blob.Fakes;&#xA;&#x9;using System;&#xA;&#x9;using System.Collections.Generic;&#xA;&#x9;using System.Configuration;&#xA;&#x9;using System.Fakes;&#xA;&#x9;using System.Globalization;&#xA;&#x9;using System.IO;&#xA;&#x9;using System.IO.Fakes;&#xA;&#x9;using System.Linq;&#xA;&#x9;using System.Net;&#xA;&#x9;using System.Net.Fakes;&#xA;&#x9;using System.Security.Cryptography;&#xA;&#x9;using System.Threading;&#xA;&#x9;using System.Threading.Tasks;&#xA;&#xA;&#x9;/// &lt;summary&gt;&#xA;&#x9;/// Tests for stream manager classes&#xA;&#x9;/// &lt;/summary&gt;&#xA;&#x9;[TestClass]&#xA;&#x9;public class StreamManagerTest&#xA;&#x9;{&#xA;&#x9;&#x9;...&#xA;&#xA;&#x9;&#x9;[TestMethod]&#xA;&#x9;&#x9;[TestCategory(&quot;Integration&quot;)]&#xA;&#x9;&#x9;public async Task AzureStorageIntegrationTest()&#xA;&#x9;&#x9;{&#xA;&#x9;&#x9;&#x9;const string sampleBlobName = &quot;Testblob&quot;;&#xA;&#xA;&#x9;&#x9;&#x9;// Read configuration settings&#xA;&#x9;&#x9;&#x9;var storageName = ConfigurationManager.AppSettings[&quot;StorageName&quot;];&#xA;&#x9;&#x9;&#x9;var storageKey = ConfigurationManager.AppSettings[&quot;StorageKey&quot;];&#xA;&#x9;&#x9;&#x9;var containerName = ConfigurationManager.AppSettings[&quot;ContainerName&quot;];&#xA;&#xA;&#x9;&#x9;&#x9;// Create normed sample board in blob storage&#xA;&#x9;&#x9;&#x9;var container = GetContainerReference(storageName, storageKey, containerName);&#xA;&#x9;&#x9;&#x9;await container.CreateIfNotExistsAsync();&#xA;&#x9;&#x9;&#x9;var blob = container.GetBlockBlobReference(sampleBlobName);&#xA;&#x9;&#x9;&#x9;if (!await blob.ExistsAsync())&#xA;&#x9;&#x9;&#x9;{&#xA;&#x9;&#x9;&#x9;&#x9;await blob.UploadFromByteArrayAsync(BoardSampleData.sampleBoard, 0, BoardSampleData.sampleBoard.Length);&#xA;&#x9;&#x9;&#x9;}&#xA;&#xA;&#x9;&#x9;&#x9;// Execute test&#xA;&#x9;&#x9;&#x9;await AzureStorageIntegrationTestInternal(storageName, storageKey, containerName, sampleBlobName);&#xA;&#x9;&#x9;}&#xA;&#xA;&#x9;&#x9;private CloudBlobContainer GetContainerReference(string storageName, string storageKey, string containerName)&#xA;&#x9;&#x9;{&#xA;&#x9;&#x9;&#x9;var credentials = new StorageCredentials(storageName, storageKey);&#xA;&#x9;&#x9;&#x9;var account = new CloudStorageAccount(credentials, true);&#xA;&#x9;&#x9;&#x9;var blobClient = account.CreateCloudBlobClient();&#xA;&#x9;&#x9;&#x9;return blobClient.GetContainerReference(containerName);&#xA;&#x9;&#x9;}&#xA;&#xA;&#x9;&#x9;private async Task AzureStorageIntegrationTestInternal(string storageName, string storageKey, string containerName, string boardName)&#xA;&#x9;&#x9;{&#xA;&#x9;&#x9;&#x9;var repository = new BoardStreamRepository(&#xA;&#x9;&#x9;&#x9;&#x9;new CloudBlobStreamManager(GetContainerReference(storageName, storageKey, containerName)));&#xA;&#x9;&#x9;&#x9;var board = await repository.LoadAsync(boardName);&#xA;&#xA;&#x9;&#x9;&#x9;Assert.IsTrue(BoardSampleData.sampleBoard.SequenceEqual((byte[])board));&#xA;&#x9;&#x9;}&#xA;&#xA;&#x9;&#x9;...&#xA;&#x9;}&#xA;}" xmlns:f="http://www.composite.net/ns/function/1.0" />
  <f:param name="CodeType" value="c#" xmlns:f="http://www.composite.net/ns/function/1.0" />
</f:function><h2 xmlns="http://www.w3.org/1999/xhtml">Sample 2: Using Stubs</h2><p xmlns="http://www.w3.org/1999/xhtml">
  <em>
    <a href="https://github.com/rstropek/Samples/blob/master/SudokuBoard/Samples.Sudoku/BoardStreamRepository.cs" target="_blank">BoardStreamRepository</a> </em> and <a href="https://github.com/rstropek/Samples/blob/master/SudokuBoard/Samples.Sudoku/IStreamManager.cs" target="_blank"><em>IStreamManager</em></a> are a perfect example for using an auto-generated <a href="http://msdn.microsoft.com/en-us/library/hh549174.aspx" target="_blank">Stub</a> to unit-test <em><a href="https://github.com/rstropek/Samples/blob/master/SudokuBoard/Samples.Sudoku/BoardStreamRepository.cs">BoardStreamRepository</a></em> on its own. Note how I use stubs in <em>SetupBoardStreamRepository</em> in the following code snippet:</p><f:function name="Composite.Web.Html.SyntaxHighlighter" xmlns:f="http://www.composite.net/ns/function/1.0">
  <f:param name="SourceCode" value="namespace Samples.Sudoku.Test&#xA;{&#xA;&#x9;using Microsoft.VisualStudio.TestTools.UnitTesting;&#xA;&#x9;using Samples.Sudoku.Fakes;&#xA;&#x9;using System;&#xA;&#x9;using System.IO;&#xA;&#x9;using System.Linq;&#xA;&#x9;using System.Threading.Tasks;&#xA;&#xA;&#x9;/// &lt;summary&gt;&#xA;&#x9;/// Tests for &lt;see cref=&quot;Samples.Sudoku.BoardStreamRepository&quot;/&gt;&#xA;&#x9;/// &lt;/summary&gt;&#xA;&#x9;[TestClass]&#xA;&#x9;public class BoardStreamRepositoryTest&#xA;&#x9;{&#xA;&#x9;&#x9;[TestMethod]&#xA;&#x9;&#x9;[TestCategory(&quot;With fakes&quot;)]&#xA;&#x9;&#x9;public async Task TestLoadBoard()&#xA;&#x9;&#x9;{&#xA;&#x9;&#x9;&#x9;// A BoardStreamRepository needs an IStreamManager. Note that we use a&#xA;&#x9;&#x9;&#x9;// stub generated by Microsoft Fakes here.&#xA;&#xA;&#x9;&#x9;&#x9;// Prepare&#xA;&#x9;&#x9;&#x9;var repository = BoardStreamRepositoryTest.SetupBoardStreamRepository(BoardSampleData.sampleBoard);&#xA;&#xA;&#x9;&#x9;&#x9;// Execute&#xA;&#x9;&#x9;&#x9;var board = await repository.LoadAsync(&quot;DummyBoardName&quot;);&#xA;&#xA;&#x9;&#x9;&#x9;// Assert&#xA;&#x9;&#x9;&#x9;Assert.IsTrue(BoardSampleData.sampleBoard.SequenceEqual((byte[])board));&#xA;&#x9;&#x9;}&#xA;&#xA;&#x9;&#x9;[TestMethod]&#xA;&#x9;&#x9;[TestCategory(&quot;With fakes&quot;)]&#xA;&#x9;&#x9;public async Task TestLoadBoardFailures()&#xA;&#x9;&#x9;{&#xA;&#x9;&#x9;&#x9;var repository = BoardStreamRepositoryTest.SetupBoardStreamRepository(new byte[] { 1, 2 });&#xA;&#xA;&#x9;&#x9;&#x9;await AssertExtensions.ThrowsExceptionAsync&lt;Exception&gt;(&#xA;&#x9;&#x9;&#x9;&#x9;async () =&gt; await repository.LoadAsync(&quot;DummyBoardName&quot;));&#xA;&#x9;&#x9;}&#xA;&#xA;&#x9;&#x9;[TestMethod]&#xA;&#x9;&#x9;[TestCategory(&quot;With fakes&quot;)]&#xA;&#x9;&#x9;public async Task TestSaveBoard()&#xA;&#x9;&#x9;{&#xA;&#x9;&#x9;&#x9;var buffer = new byte[9 * 9];&#xA;&#x9;&#x9;&#x9;var repository = BoardStreamRepositoryTest.SetupBoardStreamRepository(buffer);&#xA;&#xA;&#x9;&#x9;&#x9;await repository.SaveAsync(&quot;DummyBoardName&quot;, (Board)BoardSampleData.sampleBoard);&#xA;&#xA;&#x9;&#x9;&#x9;Assert.IsTrue(BoardSampleData.sampleBoard.SequenceEqual(buffer));&#xA;&#x9;&#x9;}&#xA;&#xA;&#x9;&#x9;private static BoardStreamRepository SetupBoardStreamRepository(byte[] buffer)&#xA;&#x9;&#x9;{&#xA;&#x9;&#x9;&#x9;var stub = new StubIStreamManager();&#xA;&#x9;&#x9;&#x9;stub.OpenStreamAsyncStringAccessMode = (_, __) =&gt;&#xA;&#x9;&#x9;&#x9;&#x9;Task.FromResult(new MemoryStream(buffer) as Stream);&#xA;&#x9;&#x9;&#x9;return new BoardStreamRepository(stub);&#xA;&#x9;&#x9;}&#xA;&#x9;}&#xA;}" xmlns:f="http://www.composite.net/ns/function/1.0" />
  <f:param name="CodeType" value="c#" xmlns:f="http://www.composite.net/ns/function/1.0" />
</f:function><h2 xmlns="http://www.w3.org/1999/xhtml">Sample 3: Using Shims</h2><p xmlns="http://www.w3.org/1999/xhtml">If you want to test <a href="https://github.com/rstropek/Samples/blob/master/SudokuBoard/Samples.Sudoku/FileStreamManager.cs"><em>FileStreamManager</em></a> and <em><a href="https://github.com/rstropek/Samples/blob/master/SudokuBoard/Samples.Sudoku/CloudBlobStreamManager.cs">CloudBlobStreamManager</a></em> but you do not want to build a complex testing environment with samples files on local storage and in Windows Azure Blob Storage, you can use <a href="http://msdn.microsoft.com/en-us/library/hh549176.aspx" target="_blank">Shims</a> to isolate your code. This also has the big advantage of keeping your unit test fast.<br /></p><f:function name="Composite.Web.Html.SyntaxHighlighter" xmlns:f="http://www.composite.net/ns/function/1.0">
  <f:param name="SourceCode" value="[TestMethod]&#xA;[TestCategory(&quot;With fakes&quot;)]&#xA;public async Task CloudBlobStreamManagerShimmedLoadTest()&#xA;{&#xA;&#x9;// Note that we use shims from Microsoft Fakes to simulate Windows Azure Blob Storage.&#xA;&#x9;using (ShimsContext.Create())&#xA;&#x9;{&#xA;&#x9;&#x9;// Setup shims&#xA;&#x9;&#x9;ShimCloudBlobContainer.AllInstances.GetBlockBlobReferenceString = (container, blobName) =&gt;&#xA;&#x9;&#x9;&#x9;{&#xA;&#x9;&#x9;&#x9;&#x9;Assert.AreEqual(dummyContainerUri, container.Uri.AbsoluteUri);&#xA;&#x9;&#x9;&#x9;&#x9;Assert.AreEqual(dummyBoardName, blobName);&#xA;&#x9;&#x9;&#x9;&#x9;return new CloudBlockBlob(new Uri(dummyContainerUri));&#xA;&#x9;&#x9;&#x9;};&#xA;&#x9;&#x9;ShimCloudBlockBlob.AllInstances.OpenReadAsync = (blob) =&gt;&#xA;&#x9;&#x9;&#x9;Task.FromResult(new MemoryStream(BoardSampleData.sampleBoard) as Stream);&#xA;&#xA;&#x9;&#x9;// Execute&#xA;&#x9;&#x9;var repository = new BoardStreamRepository(new CloudBlobStreamManager(&#xA;&#x9;&#x9;&#x9;new CloudBlobContainer(new Uri(dummyContainerUri))));&#xA;&#x9;&#x9;var result = await repository.LoadAsync(dummyBoardName);&#xA;&#xA;&#x9;&#x9;// Check result&#xA;&#x9;&#x9;Assert.IsTrue(BoardSampleData.sampleBoard.SequenceEqual((byte[])result));&#xA;&#x9;}&#xA;}&#xA;&#xA;[TestMethod]&#xA;[TestCategory(&quot;With fakes&quot;)]&#xA;public async Task FileStreamManagerShimmedLoadTest()&#xA;{&#xA;&#x9;using (ShimsContext.Create())&#xA;&#x9;{&#xA;&#x9;&#x9;// Note how we use a shimmed constructor here.&#xA;&#x9;&#x9;ShimFileStream.ConstructorStringFileMode = (@this, fileName, __) =&gt;&#xA;&#x9;&#x9;&#x9;{&#xA;&#x9;&#x9;&#x9;&#x9;Assert.IsTrue(fileName.EndsWith(&quot;\\AppData\\Roaming\\Boards\\&quot; + dummyBoardName));&#xA;&#x9;&#x9;&#x9;&#x9;new ShimFileStream(@this)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;{&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ReadAsyncByteArrayInt32Int32CancellationToken = (buffer, ___, ____, _____) =&gt;&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;{&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;BoardSampleData.sampleBoard.CopyTo(buffer, 0);&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;return Task.FromResult(BoardSampleData.sampleBoard.Length);&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;}&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;};&#xA;&#x9;&#x9;&#x9;};&#xA;&#xA;&#x9;&#x9;var repository = new BoardStreamRepository(new FileStreamManager());&#xA;&#x9;&#x9;var result = await repository.LoadAsync(dummyBoardName);&#xA;&#xA;&#x9;&#x9;Assert.IsTrue(BoardSampleData.sampleBoard.SequenceEqual((byte[])result));&#xA;&#x9;}&#xA;}" xmlns:f="http://www.composite.net/ns/function/1.0" />
  <f:param name="CodeType" value="c#" xmlns:f="http://www.composite.net/ns/function/1.0" />
</f:function><h2 xmlns="http://www.w3.org/1999/xhtml">Sample 4: Advanced Shims</h2><p xmlns="http://www.w3.org/1999/xhtml">You might want to test <em><a href="https://github.com/rstropek/Samples/blob/master/SudokuBoard/Samples.Sudoku/CloudBlobStreamManager.cs">CloudBlobStreamManager</a></em> together with the Windows Azure Storage SDK. However, you still might not want to build a test environment in Azure. The solution could be shimming .NET's <em>WebRequest</em> class. The Windows Azure Storage SDK uses it behind the scenes.</p><f:function name="Composite.Web.Html.SyntaxHighlighter" xmlns:f="http://www.composite.net/ns/function/1.0">
  <f:param name="SourceCode" value="[TestMethod]&#xA;[TestCategory(&quot;With fakes&quot;)]&#xA;public async Task CloudBlobShimmedWebRequestTest()&#xA;{&#xA;&#x9;// Setup blob to simulate&#xA;&#x9;var simulatedBlobs = new Dictionary&lt;string, byte[]&gt;();&#xA;&#x9;simulatedBlobs.Add(string.Format(&quot;/{0}/{1}&quot;, dummyContainerName, dummyBoardName), BoardSampleData.sampleBoard);&#xA;&#xA;&#x9;await this.ExecuteWithShimmedWebRequestForBlockBlobsAsync(simulatedBlobs, async () =&gt;&#xA;&#x9;&#x9;{&#xA;&#x9;&#x9;&#x9;var storageKey = ConfigurationManager.AppSettings[&quot;StorageKey&quot;];&#xA;&#xA;&#x9;&#x9;&#x9;// Execute existing unit test, but this time with shims instead of real web requests&#xA;&#x9;&#x9;&#x9;await this.AzureStorageIntegrationTestInternal(dummyStorageName, storageKey, dummyContainerName, dummyBoardName);&#xA;&#x9;&#x9;});&#xA;}&#xA;&#xA;private async Task ExecuteWithShimmedWebRequestForBlockBlobsAsync(Dictionary&lt;string, byte[]&gt; simulatedBlobs, Func&lt;Task&gt; body)&#xA;{&#xA;&#x9;// Note how we create the shims context here&#xA;&#x9;using (ShimsContext.Create())&#xA;&#x9;{&#xA;&#x9;&#x9;// Azure storage uses IAsyncResult-pattern in the background. Therefore we have to create shims&#xA;&#x9;&#x9;// for Begin/EndGetResponse. BTW - you can check the code of Azure Storage Library at&#xA;&#x9;&#x9;// https://github.com/WindowsAzure/azure-storage-net&#xA;&#x9;&#x9;ShimHttpWebRequest.AllInstances.BeginGetResponseAsyncCallbackObject = (@this, callback, state) =&gt;&#xA;&#x9;&#x9;{&#xA;&#x9;&#x9;&#x9;// Check if the request matches on of the blobs that we should simulate&#xA;&#x9;&#x9;&#x9;byte[] requestedBlob;&#xA;&#x9;&#x9;&#x9;if (!simulatedBlobs.TryGetValue(@this.RequestUri.AbsolutePath, out requestedBlob))&#xA;&#x9;&#x9;&#x9;{&#xA;&#x9;&#x9;&#x9;&#x9;Assert.Fail(&quot;Unexpected request for {0}&quot;, @this.RequestUri.AbsoluteUri);&#xA;&#x9;&#x9;&#x9;}&#xA;&#xA;&#x9;&#x9;&#x9;// Setup IAsyncResult; note how we use a stub for that.&#xA;&#x9;&#x9;&#x9;var result = new StubIAsyncResult()&#xA;&#x9;&#x9;&#x9;{&#xA;&#x9;&#x9;&#x9;&#x9;// Azure Storage Library relies on a wait handle. We give one back that is immediately set.&#xA;&#x9;&#x9;&#x9;&#x9;AsyncWaitHandleGet = () =&gt; new ManualResetEvent(true),&#xA;&#xA;&#x9;&#x9;&#x9;&#x9;// We pass on the state &#xA;&#x9;&#x9;&#x9;&#x9;AsyncStateGet = () =&gt; state&#xA;&#x9;&#x9;&#x9;};&#xA;&#xA;&#x9;&#x9;&#x9;// We immediately call the callback as we do not have to wait for a real web request to finish&#xA;&#x9;&#x9;&#x9;callback(result);&#xA;&#x9;&#x9;&#x9;return result;&#xA;&#x9;&#x9;};&#xA;&#xA;&#x9;&#x9;ShimHttpWebRequest.AllInstances.EndGetResponseIAsyncResult = (@this, __) =&gt;&#xA;&#x9;&#x9;{&#xA;&#x9;&#x9;&#x9;// Check if the request matches on of the blobs that we should simulate&#xA;&#x9;&#x9;&#x9;byte[] requestedBlob;&#xA;&#x9;&#x9;&#x9;if (!simulatedBlobs.TryGetValue(@this.RequestUri.AbsolutePath, out requestedBlob))&#xA;&#x9;&#x9;&#x9;{&#xA;&#x9;&#x9;&#x9;&#x9;Assert.Fail(&quot;Unexpected request for {0}&quot;, @this.RequestUri.AbsoluteUri);&#xA;&#x9;&#x9;&#x9;}&#xA;&#xA;&#x9;&#x9;&#x9;// Setup response headers. Read Azure Storage HTTP docs for details&#xA;&#x9;&#x9;&#x9;// (see http://msdn.microsoft.com/en-us/library/windowsazure/dd179440.aspx)&#xA;&#x9;&#x9;&#x9;var headers = new WebHeaderCollection();&#xA;&#x9;&#x9;&#x9;headers.Add(&quot;Accept-Ranges&quot;, &quot;bytes&quot;);&#xA;&#x9;&#x9;&#x9;headers.Add(&quot;ETag&quot;, &quot;0xFFFFFFFFFFFFFFF&quot;);&#xA;&#x9;&#x9;&#x9;headers.Add(&quot;x-ms-request-id&quot;, Guid.NewGuid().ToString());&#xA;&#x9;&#x9;&#x9;headers.Add(&quot;x-ms-version&quot;, &quot;2013-08-15&quot;);&#xA;&#x9;&#x9;&#x9;headers.Add(&quot;x-ms-lease-status&quot;, &quot;unlocked&quot;);&#xA;&#x9;&#x9;&#x9;headers.Add(&quot;x-ms-lease-state&quot;, &quot;available&quot;);&#xA;&#x9;&#x9;&#x9;headers.Add(&quot;x-ms-blob-type&quot;, &quot;BlockBlob&quot;);&#xA;&#x9;&#x9;&#x9;headers.Add(&quot;Date&quot;, DateTime.Now.ToString(&quot;R&quot;, CultureInfo.InvariantCulture));&#xA;&#xA;&#x9;&#x9;&#x9;// Calculate MD5 hash for our blob and add it to the response headers&#xA;&#x9;&#x9;&#x9;var md5Check = MD5.Create();&#xA;&#x9;&#x9;&#x9;md5Check.TransformBlock(requestedBlob, 0, requestedBlob.Length, null, 0);&#xA;&#x9;&#x9;&#x9;md5Check.TransformFinalBlock(new byte[0], 0, 0);&#xA;&#x9;&#x9;&#x9;var hashBytes = md5Check.Hash;&#xA;&#x9;&#x9;&#x9;var hashVal = Convert.ToBase64String(hashBytes);&#xA;&#x9;&#x9;&#x9;headers.Add(&quot;Content-MD5&quot;, hashVal);&#xA;&#xA;&#x9;&#x9;&#x9;// As the headers are complete, we can now build the shimmed web response&#xA;&#x9;&#x9;&#x9;return new ShimHttpWebResponse()&#xA;&#x9;&#x9;&#x9;{&#xA;&#x9;&#x9;&#x9;&#x9;GetResponseStream = () =&gt;&#xA;&#x9;&#x9;&#x9;&#x9;{&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;// Simulate downloaded bytes&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;return new MemoryStream(requestedBlob);&#xA;&#x9;&#x9;&#x9;&#x9;},&#xA;&#xA;&#x9;&#x9;&#x9;&#x9;// Status code depends on x-ms-range request header&#xA;&#x9;&#x9;&#x9;&#x9;// (see Azure Storage HTTP docs for details)&#xA;&#x9;&#x9;&#x9;&#x9;StatusCodeGet = () =&gt; string.IsNullOrEmpty(@this.Headers[&quot;x-ms-range&quot;]) ? HttpStatusCode.OK : HttpStatusCode.PartialContent,&#xA;&#x9;&#x9;&#x9;&#x9;HeadersGet = () =&gt; headers,&#xA;&#x9;&#x9;&#x9;&#x9;ContentLengthGet = () =&gt; requestedBlob.Length,&#xA;&#x9;&#x9;&#x9;&#x9;ContentTypeGet = () =&gt; &quot;application/octet-stream&quot;,&#xA;&#x9;&#x9;&#x9;&#x9;LastModifiedGet = () =&gt; new DateTime(2014, 1, 1)&#xA;&#x9;&#x9;&#x9;};&#xA;&#x9;&#x9;};&#xA;&#xA;&#x9;&#x9;await body();&#xA;&#x9;}&#xA;}" xmlns:f="http://www.composite.net/ns/function/1.0" />
  <f:param name="CodeType" value="c#" xmlns:f="http://www.composite.net/ns/function/1.0" />
</f:function><div id="mcepastebin" contenteditable="true" data-mce-bogus="1" style="position: absolute; top: 20px; width: 10px; height: 633px; overflow: hidden; opacity: 0; left: -65535px;" xmlns="http://www.w3.org/1999/xhtml">%MCEPASTEBIN%</div>