---
layout: blog
title: Custom OData Provider Without Underlying DB
author: Rainer Stropek
bannerimage: 
permalink: /2014/09/25/Custom-OData-Provider-Without-Underlying-DB
---

<p xmlns="http://www.w3.org/1999/xhtml">Today I will do my <a href="http://www.software-architects.com/devblog/2014/09/12/10-OData-FAQs" target="_blank">OData session</a> at <a href="http://basta.net/2014/sessions/custom-odata-providers-mit-aspnet-web-api" target="_blank">BASTA conference in Mainz</a>. This time I have a bit more time so I will add a demo of creating a custom OData provider without any underlying database. The result is generated based on the OData query on the fly. In this blog article I share the code.</p><p class="showcase" xmlns="http://www.w3.org/1999/xhtml">You can download the entire source code from <a href="https://github.com/rstropek/Samples/tree/master/CustomODataProvider" target="_blank">my GitHub Samples repository</a>.</p><h2 xmlns="http://www.w3.org/1999/xhtml">The OData Controller</h2><p xmlns="http://www.w3.org/1999/xhtml">Let's start with the important part of the sample: The <em>ODataController</em>.</p>{% highlight javascript}using Microsoft.OData.Core.UriParser.Semantic;&#xA;using Microsoft.OData.Core.UriParser.TreeNodeKinds;&#xA;using System;&#xA;using System.Collections.Generic;&#xA;using System.Linq;&#xA;using System.Text;&#xA;using System.Web.Http;&#xA;using System.Web.OData;&#xA;using System.Web.OData.Query;&#xA;using System.Web.OData.Routing;&#xA;&#xA;namespace CustomODataProvider.Provider.Controller&#xA;{&#xA;&#x9;[ODataRoutePrefix(&quot;Customers&quot;)]&#xA;&#x9;public class CustomerController : ODataController&#xA;&#x9;{&#xA;&#x9;&#x9;// Helpers for generating customer names&#xA;&#x9;&#x9;private readonly char[] letters1 = &quot;aeiou&quot;.ToArray();&#xA;&#x9;&#x9;private readonly char[] letters2 = &quot;bcdfgklmnpqrstvw&quot;.ToArray();&#xA;&#x9;&#x9;private Random random = new Random();&#xA;&#xA;&#x9;&#x9;private const int pageSize = 100;&#xA;&#xA;&#x9;&#x9;[EnableQuery(AllowedQueryOptions = AllowedQueryOptions.Filter | AllowedQueryOptions.Top | AllowedQueryOptions.Skip | AllowedQueryOptions.OrderBy)]&#xA;&#x9;&#x9;[ODataRoute]&#xA;&#x9;&#x9;public IHttpActionResult Get(ODataQueryOptions&lt;Customer&gt; options)&#xA;&#x9;&#x9;{&#xA;&#x9;&#x9;&#x9;// Calculate number of results based on $top&#xA;&#x9;&#x9;&#x9;var numberOfResults = pageSize;&#xA;&#x9;&#x9;&#x9;if (options.Top != null)&#xA;&#x9;&#x9;&#x9;{&#xA;&#x9;&#x9;&#x9;&#x9;numberOfResults = options.Top.Value;&#xA;&#x9;&#x9;&#x9;}&#xA;&#xA;&#x9;&#x9;&#x9;// Analyze $filter&#xA;&#x9;&#x9;&#x9;string equalFilter = null;&#xA;&#x9;&#x9;&#x9;if (options.Filter != null)&#xA;&#x9;&#x9;&#x9;{&#xA;&#x9;&#x9;&#x9;&#x9;// We only support a single &quot;eq&quot; filter&#xA;&#x9;&#x9;&#x9;&#x9;var binaryOperator = options.Filter.FilterClause.Expression as BinaryOperatorNode;&#xA;&#x9;&#x9;&#x9;&#x9;if (binaryOperator == null || binaryOperator.OperatorKind != BinaryOperatorKind.Equal)&#xA;&#x9;&#x9;&#x9;&#x9;{&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;return InternalServerError();&#xA;&#x9;&#x9;&#x9;&#x9;}&#xA;&#xA;&#x9;&#x9;&#x9;&#x9;// One side has to be a reference to CustomerName property, the other side has to be a constant&#xA;&#x9;&#x9;&#x9;&#x9;var propertyAccess = binaryOperator.Left as SingleValuePropertyAccessNode ?? binaryOperator.Right as SingleValuePropertyAccessNode;&#xA;&#x9;&#x9;&#x9;&#x9;var constant = binaryOperator.Left as ConstantNode ?? binaryOperator.Right as ConstantNode;&#xA;&#x9;&#x9;&#x9;&#x9;if (propertyAccess == null || propertyAccess.Property.Name != &quot;CustomerName&quot; || constant == null)&#xA;&#x9;&#x9;&#x9;&#x9;{&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;return InternalServerError();&#xA;&#x9;&#x9;&#x9;&#x9;}&#xA;&#xA;&#x9;&#x9;&#x9;&#x9;// Save equal filter value&#xA;&#x9;&#x9;&#x9;&#x9;equalFilter = constant.Value.ToString();&#xA;&#xA;&#x9;&#x9;&#x9;&#x9;// Return between 1 and 2 rows (CustomerName is not a primary key)&#xA;&#x9;&#x9;&#x9;&#x9;numberOfResults = Math.Min(random.Next(1, 3), numberOfResults);&#xA;&#x9;&#x9;&#x9;}&#xA;&#xA;&#x9;&#x9;&#x9;// Generate result&#xA;&#x9;&#x9;&#x9;var result = new List&lt;Customer&gt;();&#xA;&#x9;&#x9;&#x9;for (var i = 0; i &lt; numberOfResults; i++)&#xA;&#x9;&#x9;&#x9;{&#xA;&#x9;&#x9;&#x9;&#x9;result.Add(new Customer() { CustomerID = Guid.NewGuid(), CustomerName = equalFilter ?? GenerateCustomerName() });&#xA;&#x9;&#x9;&#x9;}&#xA;&#xA;&#x9;&#x9;&#x9;return Ok(result.AsQueryable());&#xA;&#x9;&#x9;}&#xA;&#xA;&#x9;&#x9;private string GenerateCustomerName()&#xA;&#x9;&#x9;{&#xA;&#x9;&#x9;&#x9;var length = random.Next(5, 8);&#xA;&#x9;&#x9;&#x9;var result = new StringBuilder(length);&#xA;&#x9;&#x9;&#x9;for (var i = 0; i &lt; length; i++)&#xA;&#x9;&#x9;&#x9;{&#xA;&#x9;&#x9;&#x9;&#x9;var letter = (i % 2 == 0 ? letters1[random.Next(letters1.Length)] : letters2[random.Next(letters2.Length)]).ToString();&#xA;&#x9;&#x9;&#x9;&#x9;result.Append(i == 0 ? letter.ToUpper() : letter);&#xA;&#x9;&#x9;&#x9;}&#xA;&#xA;&#x9;&#x9;&#x9;return result.ToString();&#xA;&#x9;&#x9;}&#xA;&#x9;}&#xA;}{% endhighlight javascript }<h2 xmlns="http://www.w3.org/1999/xhtml">Configuration the OData Endpoint</h2>{% highlight javascript}using Microsoft.OData.Edm;&#xA;using System.Net.Http.Formatting;&#xA;using System.Web.Http;&#xA;using System.Web.OData.Builder;&#xA;using System.Web.OData.Extensions;&#xA;using System.Web.OData.Routing.Conventions;&#xA;&#xA;namespace CustomODataProvider.Provider&#xA;{&#xA;&#x9;public static class ODataConfiguration&#xA;&#x9;{&#xA;&#x9;&#x9;public static void RegisterOData(HttpConfiguration config)&#xA;&#x9;&#x9;{&#xA;&#x9;&#x9;&#x9;config.Formatters.Clear();&#xA;&#x9;&#x9;&#x9;config.Formatters.Add(new JsonMediaTypeFormatter());&#xA;&#xA;&#x9;&#x9;&#x9;var routeConventions = ODataRoutingConventions.CreateDefault();&#xA;&#x9;&#x9;&#x9;config.MapODataServiceRoute(&quot;odata&quot;, &quot;odata&quot;, GetModel());&#xA;&#x9;&#x9;}&#xA;&#xA;&#x9;&#x9;private static IEdmModel GetModel()&#xA;&#x9;&#x9;{&#xA;&#x9;&#x9;&#x9;var modelBuilder = new ODataConventionModelBuilder();&#xA;&#x9;&#x9;&#x9;modelBuilder.EntitySet&lt;Customer&gt;(&quot;Customers&quot;);&#xA;&#x9;&#x9;&#x9;return modelBuilder.GetEdmModel();&#xA;&#x9;&#x9;}&#xA;&#x9;}&#xA;}{% endhighlight javascript }<h2 xmlns="http://www.w3.org/1999/xhtml">The Self Host</h2>{% highlight javascript}using CustomODataProvider.Provider;&#xA;using Microsoft.Owin.Hosting;&#xA;using Owin;&#xA;using System;&#xA;using System.Web.Http;&#xA;&#xA;namespace CustomODataProvider.Hosting&#xA;{&#xA;&#x9;class Program&#xA;&#x9;{&#xA;&#x9;&#x9;static void Main(string[] args)&#xA;&#x9;&#x9;{&#xA;&#x9;&#x9;&#x9;using (WebApp.Start&lt;Startup&gt;(&quot;http://localhost:5000&quot;)) &#xA;&#x9;&#x9;&#x9;{ &#xA;&#x9;&#x9;&#x9;&#x9;Console.WriteLine( &quot;Server ready... Press Enter to quit.&quot;); &#xA;&#x9;&#x9;&#x9;&#x9;Console.ReadLine(); &#xA;&#x9;&#x9;&#x9;}&#xA;&#x9;&#x9;}&#xA;&#x9;}&#xA;&#xA;&#x9;public class Startup&#xA;&#x9;{&#xA;&#x9;&#x9;public void Configuration(IAppBuilder app)&#xA;&#x9;&#x9;{&#xA;&#x9;&#x9;&#x9;var config = new HttpConfiguration();&#xA;&#x9;&#x9;&#x9;ODataConfiguration.RegisterOData(config);&#xA;&#x9;&#x9;&#x9;app.UseWebApi(config);&#xA;&#x9;&#x9;}&#xA;&#x9;}&#xA;}{% endhighlight javascript }